default_platform(:android)

platform :android do
  desc "Build release AAB"
  lane :build do
    # Clean previous builds
    sh("flutter clean")

    # Get dependencies
    sh("flutter pub get")

    # Build release AAB
    sh("flutter build appbundle --release")

    # Verify the build was created
    aab_path = "build/app/outputs/bundle/release/app-release.aab"
    unless File.exist?(aab_path)
      UI.user_error!("AAB file not found at #{aab_path}")
    end

    UI.success("AAB built successfully at #{aab_path}")
  end

  desc "Upload Play Store metadata (from repo)"
  lane :upload_metadata do
    package_name = ENV['ANDROID_PACKAGE_NAME'] || 'com.aroosi.mobile'

    unless ENV['GOOGLE_PLAY_SERVICE_ACCOUNT_JSON']&.strip&.length&.positive?
      UI.user_error!("GOOGLE_PLAY_SERVICE_ACCOUNT_JSON environment variable is required to authenticate with Google Play")
    end

    supply(
      package_name: package_name,
      json_key_data: ENV['GOOGLE_PLAY_SERVICE_ACCOUNT_JSON'],
      metadata_path: "./fastlane/metadata/android",
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_changelogs: false,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      validate_only: false
    )
  end

  desc "Deploy to Play Store"
  lane :deploy do
    package_name = ENV['ANDROID_PACKAGE_NAME'] || 'com.aroosi.mobile'

    unless ENV['GOOGLE_PLAY_SERVICE_ACCOUNT_JSON']&.strip&.length&.positive?
      UI.user_error!("GOOGLE_PLAY_SERVICE_ACCOUNT_JSON environment variable is required to authenticate with Google Play")
    end

    # Build the AAB first
    build

    # Deploy to Play Store
    supply(
      package_name: package_name,
      json_key_data: ENV['GOOGLE_PLAY_SERVICE_ACCOUNT_JSON'],
      aab: "build/app/outputs/bundle/release/app-release.aab",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      validate_only: false
    )

    UI.success("Successfully deployed to Play Store!")
  end

  desc "Promote to production"
  lane :promote do
    package_name = ENV['ANDROID_PACKAGE_NAME'] || 'com.aroosi.mobile'

    unless ENV['GOOGLE_PLAY_SERVICE_ACCOUNT_JSON']&.strip&.length&.positive?
      UI.user_error!("GOOGLE_PLAY_SERVICE_ACCOUNT_JSON environment variable is required to authenticate with Google Play")
    end

    supply(
      package_name: package_name,
      json_key_data: ENV['GOOGLE_PLAY_SERVICE_ACCOUNT_JSON'],
      track: 'production',
      rollout_fraction: 1.0,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )

    UI.success("Successfully promoted to production!")
  end

  desc "Build and deploy to Play Store"
  lane :release do
    deploy
  end
end
