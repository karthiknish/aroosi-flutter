require 'base64'

default_platform(:ios)

platform :ios do
  before_all do
    key_base64 = ENV['ASC_API_KEY_P8_BASE64'] || ENV['ASC_API_KEY_P8']
    next unless key_base64 && !key_base64.strip.empty?

    File.write('fastlane/asc_api_key.p8', Base64.decode64(key_base64))
  end

  desc "Build iOS app for release"
  lane :build do
    # Clean previous builds
    sh("flutter clean")

    # Get dependencies
    sh("flutter pub get")

    # Build iOS
    sh("flutter build ios --release --no-codesign")

    # Setup CocoaPods if needed
    cocoapods(
      clean: true,
      podfile: "./Podfile"
    )

    # Archive the app
    gym(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      configuration: "Release",
      output_directory: "./build",
      output_name: "Runner.ipa",
      clean: true,
      include_bitcode: false,
      include_symbols: true,
      export_method: "app-store"
    )

    UI.success("IPA built successfully!")
  end

  desc "Upload App Store metadata (from repo)"
  lane :upload_metadata do
    app_identifier = ENV['IOS_APP_IDENTIFIER'] || 'com.aroosi.mobile'

    api_key_id = ENV['ASC_API_KEY_ID']
    issuer_id = ENV['ASC_API_KEY_ISSUER_ID']
    key_path = 'fastlane/asc_api_key.p8'

    unless api_key_id && issuer_id
      UI.user_error!("ASC_API_KEY_ID and ASC_API_KEY_ISSUER_ID environment variables are required")
    end

    unless File.exist?(key_path)
      UI.user_error!("Provide the App Store Connect API key via ASC_API_KEY_P8_BASE64 or place it at #{key_path}")
    end

    app_store_connect_api_key(
      key_id: api_key_id,
      issuer_id: issuer_id,
      key_filepath: key_path,
      in_house: false
    )

    deliver(
      app_identifier: app_identifier,
      metadata_path: "./fastlane/metadata/ios",
      skip_screenshots: true,
      skip_binary_upload: true,
      submit_for_review: false,
      force: true
    )
  end

  desc "Deploy to TestFlight"
  lane :deploy_testflight do
    app_identifier = ENV['IOS_APP_IDENTIFIER'] || 'com.aroosi.mobile'

    api_key_id = ENV['ASC_API_KEY_ID']
    issuer_id = ENV['ASC_API_KEY_ISSUER_ID']
    key_path = 'fastlane/asc_api_key.p8'

    unless api_key_id && issuer_id
      UI.user_error!("ASC_API_KEY_ID and ASC_API_KEY_ISSUER_ID environment variables are required")
    end

    unless File.exist?(key_path)
      UI.user_error!("Provide the App Store Connect API key via ASC_API_KEY_P8_BASE64 or place it at #{key_path}")
    end

    app_store_connect_api_key(
      key_id: api_key_id,
      issuer_id: issuer_id,
      key_filepath: key_path,
      in_house: false
    )

    # Build the app first
    build

    # Upload to TestFlight
    pilot(
      app_identifier: app_identifier,
      ipa: "./build/Runner.ipa",
      skip_submission: true,
      skip_waiting_for_build_processing: true
    )

    UI.success("Successfully uploaded to TestFlight!")
  end

  desc "Deploy to App Store"
  lane :deploy do
    app_identifier = ENV['IOS_APP_IDENTIFIER'] || 'com.aroosi.mobile'

    api_key_id = ENV['ASC_API_KEY_ID']
    issuer_id = ENV['ASC_API_KEY_ISSUER_ID']
    key_path = 'fastlane/asc_api_key.p8'

    unless api_key_id && issuer_id
      UI.user_error!("ASC_API_KEY_ID and ASC_API_KEY_ISSUER_ID environment variables are required")
    end

    unless File.exist?(key_path)
      UI.user_error!("Provide the App Store Connect API key via ASC_API_KEY_P8_BASE64 or place it at #{key_path}")
    end

    app_store_connect_api_key(
      key_id: api_key_id,
      issuer_id: issuer_id,
      key_filepath: key_path,
      in_house: false
    )

    # Build the app first
    build

    # Submit for review
    deliver(
      app_identifier: app_identifier,
      ipa: "./build/Runner.ipa",
      skip_metadata: true,
      skip_screenshots: true,
      submit_for_review: true,
      automatic_release: false,
      force: true,
      precheck_include_in_app_purchases: false
    )

    UI.success("Successfully submitted for App Store review!")
  end

  desc "Build and deploy to TestFlight"
  lane :release_testflight do
    deploy_testflight
  end

  desc "Build and deploy to App Store"
  lane :release do
    deploy
  end
end
