rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection - users can read/write their own profile
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if isPublicProfile(userId);
    }
    
    // User subcollections
    match /users/{userId}/shortlist/{shortlistedUserId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    match /users/{userId}/matrimony_preferences/{preferenceId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    match /users/{userId}/settings/{settingId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Profiles collection - public profiles can be read by authenticated users
    match /profiles/{profileId} {
      allow read: if request.auth != null && isValidUser();
      allow write: if request.auth != null && request.auth.uid == profileId;
      allow create: if request.auth != null && request.auth.uid == profileId && isValidProfileData();
    }
    
    // Conversations collection - only participants can access
    match /conversations/{conversationId} {
      allow read, write: if request.auth != null && 
        isParticipantInConversation(request.auth.uid, conversationId);
      allow create: if request.auth != null && 
        isValidConversationCreate(request.auth.uid, request.resource.data);
    }
    
    // Messages subcollection - only participants can access their conversation's messages
    match /conversations/{conversationId}/messages/{messageId} {
      allow read, write: if request.auth != null && 
        isParticipantInConversation(request.auth.uid, conversationId);
      allow create: if request.auth != null && 
        isParticipantInConversation(request.auth.uid, conversationId) &&
        isValidMessageCreate(request.resource.data);
    }
    
    // Chats collection - alternative chat implementation
    match /chats/{chatId} {
      allow read, write: if request.auth != null && 
        (resource.data.senderId == request.auth.uid || 
         resource.data.receiverId == request.auth.uid);
      allow create: if request.auth != null && 
        request.resource.data.senderId == request.auth.uid &&
        isValidChatMessage(request.resource.data);
    }
    
    // Matches collection - only users involved can read/write
    match /matches/{matchId} {
      allow read: if request.auth != null && 
        (resource.data.userId == request.auth.uid || 
         resource.data.matchedUserId == request.auth.uid);
      allow write: if request.auth != null && 
        (resource.data.userId == request.auth.uid || 
         resource.data.matchedUserId == request.auth.uid);
      allow create: if request.auth != null && 
        (request.resource.data.userId == request.auth.uid || 
         request.resource.data.matchedUserId == request.auth.uid);
    }
    
    // Interests collection - senders/receivers can access their interests
    match /interests/{interestId} {
      allow read: if request.auth != null && 
        (resource.data.fromUserId == request.auth.uid || 
         resource.data.toUserId == request.auth.uid);
      allow create: if request.auth != null && 
        request.resource.data.fromUserId == request.auth.uid &&
        isValidInterestCreate(request.resource.data);
      allow update: if request.auth != null && 
        resource.data.toUserId == request.auth.uid;
    }
    
    // Reports collection - users can create reports, admins can read
    match /reports/{reportId} {
      allow create: if request.auth != null && 
        request.resource.data.reporterId == request.auth.uid &&
        isValidReportCreate(request.resource.data);
      allow read: if request.auth != null && isAdmin(request.auth.uid);
    }
    
    // Blocks collection - users can manage their own blocks
    match /blocks/{blockId} {
      allow read: if request.auth != null && 
        resource.data.blockerId == request.auth.uid;
      allow create: if request.auth != null && 
        request.resource.data.blockerId == request.auth.uid;
    }
    
    // Blocked users collection - users can manage their own blocks
    match /blocked_users/{blockId} {
      allow read: if request.auth != null && 
        resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    // Icebreaker questions - read-only for all authenticated users
    match /icebreaker_questions/{questionId} {
      allow read: if request.auth != null;
      allow write: if false; // Server only - questions uploaded via admin script
    }

    // Icebreaker answers - users can read/write their own answers
    match /icebreaker_answers/{answerId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
      allow delete: if false;
    }
    
    // Islamic Educational Content - authenticated users can read, admins can write
    match /islamic_educational_content/{contentId} {
      allow read: if request.auth != null && isValidUser();
      allow write: if request.auth != null && isAdmin(request.auth.uid);
    }
    
    // Afghan Cultural Traditions - authenticated users can read, admins can write
    match /afghan_cultural_traditions/{traditionId} {
      allow read: if request.auth != null && isValidUser();
      allow write: if request.auth != null && isAdmin(request.auth.uid);
    }
    
    // User Education Progress - users can read/write their own progress
    match /user_education_progress/{progressId} {
      allow read, write: if request.auth != null && 
        resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
    }
    
    // Quiz Results - users can read/write their own results
    match /quiz_results/{resultId} {
      allow read, write: if request.auth != null && 
        resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
    }
    
    // Content Likes - users can create their own likes, read all
    match /content_likes/{likeId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    // User Bookmarks - users can read/write their own bookmarks
    match /user_bookmarks/{bookmarkId} {
      allow read, write: if request.auth != null && 
        resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    // Admin Roles - only admins can read/write
    match /admin_roles/{roleId} {
      allow read, write: if request.auth != null && isAdmin(request.auth.uid);
    }
    
    // Admin Audit Log - only admins can read, system can write
    match /admin_audit_log/{logId} {
      allow read: if request.auth != null && isAdmin(request.auth.uid);
      allow create: if request.auth != null; // Users can create their own audit entries
      allow write: if request.auth != null && isAdmin(request.auth.uid);
    }
    
    // Default deny for all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

// Helper functions

function isValidUser() {
  return request.auth != null && request.auth.token.email_verified == true;
}

function isPublicProfile(userId) {
  return exists(/databases/(default)/documents/users/$(userId)) &&
    get(/databases/(default)/documents/users/$(userId)).data.isPublic == true;
}

function isParticipantInConversation(userId, conversationId) {
  return exists(/databases/(default)/documents/conversations/$(conversationId)) &&
    userId in get(/databases/(default)/documents/conversations/$(conversationId)).data.participants;
}

function isValidConversationCreate(userId, data) {
  return userId in data.participants && 
    data.participants.size() >= 2 &&
    data.participants.size() <= 2;
}

function isValidMessageCreate(data) {
  return data.text is string && 
    data.text.size() > 0 &&
    data.text.size() <= 1000 &&
    data.fromUserId == request.auth.uid;
}

function isValidChatMessage(data) {
  return data.senderId == request.auth.uid &&
    data.content is string &&
    data.content.size() > 0 &&
    data.content.size() <= 1000;
}

function isValidProfileData() {
  return request.resource.data.keys().hasAll(['name', 'age', 'gender']) &&
    request.resource.data.name is string &&
    request.resource.data.name.size() > 0 &&
    request.resource.data.age is int &&
    request.resource.data.age >= 18 &&
    request.resource.data.age <= 100;
}

function isValidInterestCreate(data) {
  return data.fromUserId == request.auth.uid &&
    data.fromUserId != data.toUserId &&
    data.status in ['pending', 'accepted', 'rejected'];
}

function isValidReportCreate(data) {
  return data.reporterId == request.auth.uid &&
    data.reporterId != data.reportedUserId &&
    data.reason is string &&
    data.reason.size() > 0;
}

function isAdmin(userId) {
  // Check admin_roles collection first (preferred method)
  return exists(/databases/(default)/documents/admin_roles/$(userId)) &&
    get(/databases/(default)/documents/admin_roles/$(userId)).data.is_active == true &&
    (get(/databases/(default)/documents/admin_roles/$(userId)).data.role == 'admin' ||
     get(/databases/(default)/documents/admin_roles/$(userId)).data.role == 'super_admin');
}
